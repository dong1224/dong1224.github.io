# qom-源码分析之属性

## 属性模版

	struct Property {
		const char   *name;
		PropertyInfo *info;
		ptrdiff_t    offset;
		uint8_t      bitnr;
		QType        qtype;
		int64_t      defval;
		int          arrayoffset;
		PropertyInfo *arrayinfo;
		int          arrayfieldsize;
	};

## 属性对象

属性对象包含属性名称、类型、描述，类型对应的属性结构，以及相应访问函数。

	typedef struct ObjectProperty
	{
		gchar *name;
		gchar *type;
		gchar *description;
		ObjectPropertyAccessor *get;
		ObjectPropertyAccessor *set;
		ObjectPropertyResolve *resolve;
		ObjectPropertyRelease *release;
		void *opaque;
	} ObjectProperty;
	
object初始化，也就是在调用instance_init的时候添加属性

	//添加属性的时候，把get set方法的函数指针也穿进去
	void object_property_add_bool(Object *obj, const char *name,
                              bool (*get)(Object *, Error **),
                              void (*set)(Object *, bool, Error **),
                              Error **errp)
	{
		Error *local_err = NULL;
		BoolProperty *prop = g_malloc0(sizeof(*prop));

		prop->get = get;
		prop->set = set;

		object_property_add(obj, name, "bool",
							get ? property_get_bool : NULL,
							set ? property_set_bool : NULL,
							property_release_bool,
							prop, &local_err);
		if (local_err) {
			error_propagate(errp, local_err);
			g_free(prop);
		}
	}

这里是有疑问的，在type device的类对象里面，是有realized这个成员的，那为啥又要折腾一下用object_property_add去设置呢。
举个例子，type device在初始化object的时候，也就是调用instance_init的时候添加bool属性。名字为realized
这个好理解
	
	object_property_add_bool(obj, "realized", device_get_realized, device_set_realized, NULL)
	static bool device_get_realized(Object *obj, Error **errp)
	{
		DeviceState *dev = DEVICE(obj);
		return dev->realized;
	}
	
下面这个属性就不一样了，它并没有在object中有实体的定义
	object_property_add_bool(obj, "hotpluggable",
                             device_get_hotpluggable, NULL, NULL);
	static bool device_get_hotpluggable(Object *obj, Error **errp)
	{
		DeviceClass *dc = DEVICE_GET_CLASS(obj);
		DeviceState *dev = DEVICE(obj);

		return dc->hotpluggable && (dev->parent_bus == NULL ||
									qbus_is_hotpluggable(dev->parent_bus));
	}

通过object_property_add添加的属性，是有外部接口的。或者说property提供了对外表现的属性，而内部如何实现这种属性其实是通过回调函数封装过的。

## ObjectClass属性和Object属性有什么区别



### 查看属性

可以通过qemu直接查看属性

	/home/binss/work/qemu/qemu-2.8.1.1/x86_64-softmmu/qemu-system-x86_64 -device ?
	/home/binss/work/qemu/qemu-2.8.1.1/x86_64-softmmu/qemu-system-x86_64 -device vfio-pci,?
	
查看qom树

	virsh qemu-monitor-command domain1 --hmp "info qom-tree"
	




